<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta charset="utf-8"/>
    <title>測試bus</title>
    <style>
        .route-details {
            display: none;
        }
    </style>
</head>
<body>
    <h1>測試bus</h1>
    <form id="busForm">
        <div>輸入巴士名稱<input type="text" name="message" id="message"></div>
        <button type="submit">確認</button>
    </form>
    <span>
        <button id="firstend" style="display:none;"></button>
        <button id="secondend" style="display:none;"></button>
    </span>
    <div id="updateTime"></div>
    <div id="container"></div>
    <script>
    document.getElementById("busForm").addEventListener('submit', async function(event) {
    event.preventDefault();
    const message = document.getElementById('message').value;
    const container = document.getElementById('container');
    const updateTimeContainer = document.getElementById('updateTime'); // 新增的更新時間容器
    container.innerHTML = '';

    const now = new Date();
    updateTimeContainer.innerHTML = `最後更新時間: ${now.toLocaleTimeString()}`;
    
    let currentIndex = 0;
    const firstend = document.getElementById('firstend');
    const secondend = document.getElementById('secondend');
    firstend.style.display = 'block';
    secondend.style.display = 'block';

    // 初次顯示路線資訊，不需要頻繁更新
    const response = await fetch(`/search/${message}`);
    const data = await response.json();
    if (response.ok) {
        showRoute(currentIndex);
    } else {
        container.innerHTML = `<p>Route not found</p>`;
        firstend.style.display = 'none';
        secondend.style.display = 'none';
    }

    let cachedEstimatedTimes = null;

    async function fetchEstimatedTime(routeName) {
        if (cachedEstimatedTimes) {
            return cachedEstimatedTimes;
        }

        try {
            const estimateResponse = await fetch(`/search_estimate?route_name=${routeName}`);
            if (estimateResponse.ok) {
                const data = await estimateResponse.json();
                cachedEstimatedTimes = data; // 緩存數據
                return data;
            } else {
                throw new Error('Failed to fetch estimated time');
            }
        } catch (error) {
            console.error('Error:', error);
            return { direction_0: [], direction_1: [] };
        }
    }


    function renderRouteInfo(route, estimatedTimes) {
        const directionKey = route.direction === 0 ? 'direction_0' : 'direction_1';
        const stopsList = route.stops.map(function(stop) {
        const estimatedTime = estimatedTimes[directionKey].find(item => item.stop_name === stop) || {};
        let displayTime;

            if (estimatedTime.estimated_time !== null) {
                // 有預估時間的情況
                const estimatedMinutes = Math.floor(estimatedTime.estimated_time / 60);
                if (estimatedMinutes <= 2) {
                    displayTime = "即將到站";
                } else {
                    displayTime = `${estimatedMinutes} 分鐘`;
                }
            } else {
                // 沒有預估時間，根據 stop_status 顯示
                switch (estimatedTime.stop_status) {
                    case 1:
                        displayTime = "未發車";
                        break;
                    case 2:
                        displayTime = "交管不停靠";
                        break;
                    case 3:
                        displayTime = "末班車已過";
                        break;
                    default:
                        displayTime = 'N/A';
                }
            }

                return `<li>${stop} - ${displayTime}</li>`;
            }).join('');

            container.innerHTML = `
                <h3>Route Name: ${route.route_name}</h3>
                <div class="route-details" style="display:block;">
                    <p>Stops:</p>
                    <ul>${stopsList}</ul>
                </div>
            `;

            if (route.direction == '0'){
                firstend.innerHTML = `往 ${route.end}`;
                secondend.innerHTML = `往 ${route.start}`;
            } else {
                firstend.innerHTML = `往 ${route.start}`;
                secondend.innerHTML = `往 ${route.end}`;
            }
        }

        async function showRoute(index) {
            const route = data[index];
            const estimatedTimes = await fetchEstimatedTime(route.route_name);
            renderRouteInfo(route, estimatedTimes);
        }

        async function updateEstimatedTime() {
            const route = data[currentIndex];
            const estimatedTimes = await fetchEstimatedTime(route.route_name);
            renderRouteInfo(route, estimatedTimes);

            // 更新最新的更新時間
            const now = new Date();
            updateTimeContainer.innerHTML = `最後更新時間: ${now.toLocaleTimeString()}`;
        }

        // 初次顯示
        showRoute(currentIndex);

        // 每 30 秒更新一次預估時間
        setInterval(updateEstimatedTime, 30000);

        firstend.addEventListener('click', function() {
            currentIndex = 0;
            showRoute(currentIndex);
        });

        secondend.addEventListener('click', function() {
            currentIndex = 1;
            showRoute(currentIndex);
        });
    });

    </script>
</body>
</html>
