<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台北BusConnect - 會員頁面</title>
    <link rel="stylesheet" href="/static/memberpage.css">
    <script type="module" src="/static/notifications.js" defer></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">台北Busconnect</a>
            </ul>
        </div>
    </nav>
    <div id="info-container">
        <div id="hellotitle"></div>
        <div id="favorite-title">我的最愛</div>
        <div id="favorite-container"></div>
        <!-- 路線名稱將會動態加入這裡 -->
         <div id="subscription-title">我的訂閱</div>
        <div id="subscription-container"></div>
    </div>
    <script type="module">
        let member_id = 0;
        import { sendNotification, requestNotificationPermission } from '/static/notifications.js';
         document.addEventListener('DOMContentLoaded',async () => {
                await getCurrentUser(); // 檢查當前用戶資訊
                fetchFavorites(member_id);
                fetchSubscriptions(member_id);
            });
                // 檢查當前用戶資訊函數
                async function getCurrentUser() {
                    const token = localStorage.getItem('access_token');
                    const authLink = document.getElementById('auth-link');
                    if (token) {
                        try {
                            let response = await fetch('/auth/verify-token', {
                                method: 'GET',
                                headers: {
                                    'Authorization': `Bearer ${token}`  // 添加 Bearer token
                                }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                const title=document.getElementById('hellotitle')
                                title.innerHTML = `你好! ${data.user_name}`;
                                member_id = data.user_id;
                            } else {
                                // Token無效，顯示登入/註冊選項
                                window.location.href = '/';
                            }
                        } catch (error) {
                            window.location.href = '/';;
                        }
                    } else {
                        window.location.href = '/';
                    }
                }
        async function fetchFavorites(memberId) {
            const token = localStorage.getItem('access_token');
            let response = await fetch(`/api/favorites/${memberId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const favorites = await response.json();
                const container = document.getElementById('favorite-container');
                container.innerHTML = ''; // 清空之前的內容
                favorites.forEach(favorite => {
                    const div = document.createElement('div');
                    div.className = 'favorite-item';
                    div.innerHTML = `
                        <span>${favorite.route_name}</span>
                        <button class="remove-button" data-route="${favorite.route_name}">刪除</button>
                    `;
                    container.appendChild(div);
                });
                // 綁定刪除按鈕事件
                document.querySelectorAll('.remove-button').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const routeName = event.target.getAttribute('data-route');
                        await removeFavorite(member_id, routeName);
                    });
                });
            }
        }
        async function removeFavorite(memberId, routeName) {
            try {
                const response = await fetch(`/api/favorites/${memberId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ route_name: routeName })
                });

                if (response.ok) {
                    alert("我的最愛已刪除");
                    // 重新加載我的最愛列表
                    await fetchFavorites(memberId);
                } else {
                    console.error("刪除我的最愛失敗");
                }
            } catch (error) {
                console.error("無法刪除我的最愛:", error);
            }
        }
        async function fetchSubscriptions(memberId) {
            const response = await fetch(`/api/subscriptions/${memberId}`, {
                method: 'GET'
            });

            if (response.ok) {
                const subscriptions = await response.json();
                const container = document.getElementById('subscription-container');
                container.innerHTML = ''; // 清空之前的內容
                subscriptions.forEach(subscription => {
                    const div = document.createElement('div');
                    div.className = 'subscription-item';
                    div.innerHTML = `
                        <span>${subscription.route_name} - ${subscription.neareststop}</span>
                        <input type="time" id="notificationTime-${subscription.id}" name="notificationTime" value="${subscription.notification_time}" required>
                        <button class="update-subscription" data-id="${subscription.id}">更新時間</button>
                        <button class="remove-subscription" data-id="${subscription.id}">刪除</button>
                    `;
                    container.appendChild(div);
                });

                // 綁定更新按鈕事件
                document.querySelectorAll('.update-subscription').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const subscriptionId = event.target.getAttribute('data-id');
                        const newTime = document.getElementById(`notificationTime-${subscriptionId}`).value;
                        await updateSubscriptionTime(member_id, subscriptionId, newTime);
                    });
                });

                // 綁定刪除按鈕事件
                document.querySelectorAll('.remove-subscription').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const subscriptionId = event.target.getAttribute('data-id');
                        await removeSubscription(member_id, subscriptionId);
                    });
                });
            } else {
                console.error("無法加載訂閱列表:", response.statusText);
            }
        }

        async function updateSubscriptionTime(memberId, subscriptionId, newTime) {
            try {
                const response = await fetch(`/api/subscriptions/${memberId}/${subscriptionId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notification_time: newTime })
                });

                if (response.ok) {
                    alert("訂閱時間已更新");
                    // 重新加載訂閱列表
                    fetchSubscriptions(memberId);
                } else {
                    console.error("更新訂閱時間失敗");
                }
            } catch (error) {
                console.error("無法更新訂閱時間:", error);
            }
        }
        async function removeSubscription(memberId, subscriptionId) {
            try {
                const response = await fetch(`/api/subscriptions/${memberId}/${subscriptionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert("訂閱已刪除");
                    // 重新加載訂閱列表
                    fetchSubscriptions(memberId);
                } else {
                    console.error("刪除訂閱失敗");
                }
            } catch (error) {
                console.error("無法刪除訂閱:", error);
            }
        }
    </script>
</body>
</html>