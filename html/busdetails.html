<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta charset="utf-8"/>
    <title>台北BusConnect - 詳細資訊</title>
    <style>
        .route-details {
            display: none;
        }
    </style>
</head>
<body>
    <a href="/">回首頁</a>
    <h1 id="routeTitle">巴士路線詳細資訊</h1>
    <span>
        <button id="firstend" style="display:none;"></button>
        <button id="secondend" style="display:none;"></button>
        <button id="gps">最近站牌</button>
    </span>
    <div id="location"></div>
    <div id="updateTime"></div>
    <div id="container"></div>
    <script>
    let currentIndex = 0;
    document.addEventListener('DOMContentLoaded', async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const routeName = urlParams.get('route_name');
        const container = document.getElementById('container');
        const updateTimeContainer = document.getElementById('updateTime');
        const routeTitle = document.getElementById('routeTitle');
        
        routeTitle.textContent = `${routeName}路線詳細資訊`;
        const firstend = document.getElementById('firstend');
        const secondend = document.getElementById('secondend');
        const responsegps = await fetch(`/api/searchlocation?route_name=${routeName}`);
        locationData = await responsegps.json()
        let allData = null;
        let allEstimatedTimes = null;       
        const response = await fetch(`/api/search/${routeName}`);
        if (response.ok) {
            allData = await response.json();
            allEstimatedTimes = await fetchEstimatedTime(routeName);
            renderRouteInfo(currentIndex);

            firstend.style.display = 'block';
            secondend.style.display = 'block';

            const now = new Date();
            updateTimeContainer.innerHTML = `最後更新時間: ${now.toLocaleTimeString()}`;

            const updateTimes = async () => {
                allEstimatedTimes = await fetchEstimatedTime(routeName);
                renderRouteInfo(currentIndex);

                const now = new Date();
                updateTimeContainer.innerHTML = `最後更新時間: ${now.toLocaleTimeString()}`;
            };

            updateTimes();
            setInterval(updateTimes, 30000);
        } else {
            container.innerHTML = `<p>Route not found</p>`;
            firstend.style.display = 'none';
            secondend.style.display = 'none';
        }

        async function fetchEstimatedTime(routeName) {
            try {
                const estimateResponse = await fetch(`/api/search_estimate?route_name=${routeName}`);
                if (estimateResponse.ok) {
                    return await estimateResponse.json();
                } else {
                    throw new Error('Failed to fetch estimated time');
                }
            } catch (error) {
                console.error('Error:', error);
                return { direction_0: [], direction_1: [] };
            }
        }

        function renderRouteInfo(directionIndex) {
            const route = allData[directionIndex];
            const directionKey = route.direction === 0 ? 'direction_0' : 'direction_1';
            const estimatedTimes = allEstimatedTimes[directionKey];

            const stopsList = route.stops.map(function(stop) {
                const estimatedTime = estimatedTimes.find(item => item.stop_name === stop) || {};
                let displayTime = 'N/A';

                if (estimatedTime.estimated_time !== null) {
                    const estimatedMinutes = Math.floor(estimatedTime.estimated_time / 60);
                    displayTime = estimatedMinutes <= 2 ? "即將到站" : `${estimatedMinutes} 分鐘`;
                } else {
                    switch (estimatedTime.stop_status) {
                        case 1:
                            displayTime = "未發車";
                            break;
                        case 2:
                            displayTime = "交管不停靠";
                            break;
                        case 3:
                            displayTime = "末班車已過";
                            break;
                        default:
                            displayTime = 'N/A';
                    }
                }

                return `<li>${stop} - ${displayTime}</li>`;
            }).join('');

            container.innerHTML = `
                <h3>Route Name: ${route.route_name}</h3>
                <div class="route-details" style="display:block;">
                    <p>Stops:</p>
                    <ul>${stopsList}</ul>
                </div>
            `;

            if (route.direction === 0) {
                firstend.innerHTML = `往 ${route.end}`;
                secondend.innerHTML = `往 ${route.start}`;
            } else {
                firstend.innerHTML = `往 ${route.start}`;
                secondend.innerHTML = `往 ${route.end}`;
            }
        }

        firstend.addEventListener('click', function() {
            currentIndex = 0;
            renderRouteInfo(currentIndex);
            document.getElementById('gps').click();
        });

        secondend.addEventListener('click', function() {
            currentIndex = 1;
            renderRouteInfo(currentIndex);
            document.getElementById('gps').click();
        });

        document.getElementById('gps').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const filteredLocationData = locationData.filter(stop => stop.direction === currentIndex);
                    if (filteredLocationData) {
                        const nearestStop = findNearestStop(lat, lon, filteredLocationData);
                        document.getElementById('location').innerHTML = `最近站牌為:${nearestStop.stop_name}`
                    } else {
                        console.log("Location data not available.");
                    }
                }, function(error) {
                    console.log("Error getting location:", error);
                });
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        });

        function findNearestStop(userLat, userLon, stops) {
            let minDistance = Infinity;
            let nearestStop = null;

            stops.forEach(stop => {
                const distance = calculateDistance(userLat, userLon, stop.position_lat, stop.position_lon);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStop = stop;
                }
            });

            return nearestStop;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半徑，單位為公里
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }
    });
    </script>
</body>
</html>
